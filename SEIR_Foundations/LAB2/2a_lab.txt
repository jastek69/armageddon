Lab 2 Architecture

Internet → CloudFront (+ WAF) → ALB (locked to CloudFront) → Private EC2 → RDS

Key constraints
  No one can hit ALB directly (even if they know ALB DNS)
  WAF enforcement happens at CloudFront edge
  DNS points to CloudFront, not ALB


Terraform Overlay: lab2_cloudfront_origin_cloaking.tf

Assumes you already have:
  aws_lb.chewbacca_alb01
  aws_security_group.chewbacca_alb_sg01
  Route53 zone from Bonus-B
  WAF already exists (you’ll replace it with CLOUDFRONT-scoped WAF below)

0) CloudFront must use ACM cert in us-east-1
CloudFront viewer certs must be in N. Virginia (us-east-1). (This is standard AWS behavior; keep it as a lab rule.)
So you will either:
    create a second provider alias for us-east-1, or
    manually create cert and paste ARN (less ideal)

1) Origin cloaking: Allow ALB inbound only from CloudFront prefix list
#lab2_cloudfront_origin_cloaking.tf

Now add/replace your ALB SG ingress:
#lab2_cloudfront_origin_cloaking.tf

Why this works: AWS provides an AWS-managed prefix list for CloudFront origin-facing IP ranges, maintained by AWS.

2) Add a secret “origin header” that ALB requires
CloudFront will add this header, and ALB will only forward requests that contain it. This is the second layer (defense-in-depth), because anyone can create a CloudFront distribution and use the prefix list trick alone isn’t perfect. AWS explicitly documents the “custom header + ALB rule” approach.

